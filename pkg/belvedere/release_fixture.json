{
  "resources": [
    {
      "name": "my-app-v43-it",
      "type": "compute.beta.instanceTemplate",
      "properties": {
        "properties": {
          "disks": [
            {
              "autoDelete": true,
              "boot": true,
              "deviceName": "boot",
              "initializeParams": {
                "sourceImage": "https://www.googleapis.com/compute/v1/projects/gce-uefi-images/global/images/family/cos-stable"
              },
              "type": "PERSISTENT"
            }
          ],
          "labels": {
            "belvedere-app": "my-app",
            "belvedere-release": "v43"
          },
          "machineType": "n1-standard-1",
          "metadata": {
            "items": [
              {
                "key": "disable-legacy-endpoints",
                "value": "true"
              },
              {
                "key": "enable-os-login",
                "value": "true"
              },
              {
                "key": "google-logging-enable",
                "value": "true"
              },
              {
                "key": "user-data",
                "value": "#cloud-configs\nwrite_files:\n- path: /etc/systemd/system/docker-my-app.service\n  permissions: \"0644\"\n  owner: root\n  content: |\n    [Unit]\n    Description=Start the my-app container\n    Wants=gcr-online.target\n    After=gcr-online.target\n\n    [Service]\n    Environment=\"HOME=/var/lib/docker\"\n    ExecStartPre=/usr/bin/docker-credential-gcr configure-docker\n    ExecStart=/usr/bin/docker run --rm --log-driver gcplogs --log-opt labels=app,release --name my-app --network host --oom-kill-disable --label app=my-app --label release=v43 --env RELEASE=v43 --env ONE=1 --env TWO=2 --turbo gcr.io/example/helloworld@sha256:abcdef0123456789 /usr/bin/helloworld one two\n    ExecStop=/usr/bin/docker stop my-app\n    ExecStopPost=/usr/bin/docker rm my-app\n- path: /etc/systemd/system/docker-nginx.service\n  permissions: \"0644\"\n  owner: root\n  content: |\n    [Unit]\n    Description=Start the nginx container\n    Wants=gcr-online.target\n    After=gcr-online.target\n\n    [Service]\n    Environment=\"HOME=/var/lib/docker\"\n    ExecStartPre=/usr/bin/docker-credential-gcr configure-docker\n    ExecStart=/usr/bin/docker run --rm --log-driver gcplogs --log-opt labels=app,release,sidecar --name nginx --network host --oom-kill-disable --label app=my-app --label release=v43 --label sidecar=nginx --env FOUR=4 --env THREE=3 --slow gcr.io/example/nginx /usr/bin/nginx three four\n    ExecStop=/usr/bin/docker stop nginx\n    ExecStopPost=/usr/bin/docker rm nginx\nruncmd:\n- iptables -w -A INPUT -p tcp --dport 8443 -j ACCEPT\n- systemctl daemon-reload\n- systemctl start docker-my-app.service\n- systemctl start docker-nginx.service\n"
              }
            ]
          },
          "networkInterfaces": [
            {
              "accessConfigs": [
                {
                  "name": "External NAT",
                  "type": "ONE_TO_ONE_NAT"
                }
              ],
              "network": "global/networks/default"
            }
          ],
          "serviceAccounts": [
            {
              "email": "app-my-app@my-project.iam.gserviceaccount.com",
              "scopes": [
                "https://www.googleapis.com/auth/cloud-platform"
              ]
            }
          ],
          "shieldedVmConfig": {
            "enableIntegrityMonitoring": true,
            "enableSecureBoot": true,
            "enableVtpm": true
          },
          "tags": {
            "items": [
              "belvedere",
              "belvedere-my-app"
            ]
          }
        }
      }
    },
    {
      "name": "my-app-v43-ig",
      "type": "compute.beta.regionInstanceGroupManager",
      "properties": {
        "baseInstanceName": "my-app-v43",
        "instanceTemplate": "$(ref.my-app-v43-it.selfLink)",
        "namedPorts": [
          {
            "name": "svc-https",
            "port": 8443
          }
        ],
        "region": "us-central1",
        "targetSize": 20
      }
    },
    {
      "name": "my-app-v43-as",
      "type": "compute.beta.regionAutoscaler",
      "properties": {
        "autoscalingPolicy": {
          "loadBalancingUtilization": {
            "utilizationTarget": 0.6
          },
          "maxNumReplicas": 100,
          "minNumReplicas": 10
        },
        "name": "my-app-v43",
        "region": "us-central1",
        "target": "$(ref.my-app-v43-ig.selfLink)"
      }
    }
  ]
}